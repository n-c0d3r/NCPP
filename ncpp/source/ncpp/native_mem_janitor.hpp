#pragma once

/** @file ncpp/native_mem_janitor.hpp
 * 	@brief Implements native mem janitor.
*/



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



#pragma region Includes

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

#include <ncpp/prerequisites.hpp>

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

#include <ncpp/utilities/lref.hpp>
#include <ncpp/mem.hpp>
#include <ncpp/native_heap.hpp>
#include <ncpp/native_allocator.hpp>

#pragma endregion



 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



namespace ncpp {



	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



	class native_mem_janitor {

	private:
		utilities::lref_t<native_allocator_i> last_allocator_ref_;
		utilities::lref_t<native_allocator_i> target_allocator_ref_;



	public:
		inline native_allocator_i& last_allocator() { return *last_allocator_ref_; }
		inline native_allocator_i& target_allocator() { return *target_allocator_ref_; }



	public:
		inline native_mem_janitor(const native_allocator_i& target_allocator) :
			last_allocator_ref_(current_native_allocator()),
			target_allocator_ref_(target_allocator)
		{

			if(!target_allocator_ref_.is_null())
				target_allocator_ref_->apply_native_use();

		}
		virtual ~native_mem_janitor() {

			last_allocator_ref_->apply_native_use();

		}

	};



	template<class allocator_type>
	class native_mem_auto_janitor_t : public native_mem_janitor{

	private:
		allocator_type target_allocator_;



	public:
		inline allocator_type& target_allocator() { return target_allocator_; }



	public:
		inline native_mem_auto_janitor_t() :
			native_mem_janitor(*utilities::lref_t<allocator_type>())
		{

			target_allocator_.apply_native_use();

		}
		~native_mem_auto_janitor_t() {



		}

	};



#define NCPP_NATIVE_MEM_JANITOR(target_allocator, ...) ncpp::native_native_mem_janitor mem_janitor_##__VA_ARGS__(target_allocator);
#define NCPP_NATIVE_MEM_AUTO_JANITOR(target_allocator_type, ...) ncpp::native_mem_auto_janitor_t<target_allocator_type> mem_janitor_##__VA_ARGS__;

}

