#pragma once

/** @file ncpp/iostream.hpp
*	@brief Implement iostream with custom allocators,...
*/



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



#pragma region Includes

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include <ncpp/prerequisites.hpp>

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#ifdef NCPP_ENABLE_MEMORY_COUNTING
#include <ncpp/memory_counting.hpp>
#endif

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

#include <ncpp/utilities/is_streamable.hpp>

#pragma endregion



 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



namespace ncpp {



	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



	/**
	 *	Wraps the input data reference inside and also stores the tab count for with-tabs out streaming operation. 
	 */
	template<typename type__>
	using ostream_input_t = typename std::pair<const type__&, u32>;



	// \cond INTERNAL
	template<typename stream_type__, typename type__, b8 is_streamable__>
	struct safe_ostream_forwarder_t {

	};

	template<typename stream_type__, typename type__>
	struct safe_ostream_forwarder_t<stream_type__, type__, true> {

		static inline stream_type__& forward(stream_type__& stream, type__&& data) {

			stream << data;

			return stream;
		}
	};

	template<typename stream_type__, typename type__>
	struct safe_ostream_forwarder_t<stream_type__, type__, false> {

		static inline stream_type__& forward(stream_type__& stream, type__&& data) {



			return stream;
		}
	};
	// \endcond



	/**
	 *	Take the out streaming operation safely.
	 *	If data is out streamable, stream out the data.
	 *	Otherwise, do nothing and wont cause any error.
	 */
	template<typename stream_type__, typename type__>
	inline stream_type__& safe_ostream_t(stream_type__& stream, type__&& data) {

		using safe_ostream_forward_type = safe_ostream_forwarder_t<
			stream_type__,
			type__,
			utilities::is_ostreamable_t<
				stream_type__,
				type__
			>::value
		>;
			
		return safe_ostream_forward_type::forward(stream, std::forward<type__>(data));
	}



	// \cond INTERNAL
	template<typename stream_type__, typename input_type__, b8 is_streamable__>
	struct safe_ostream_with_tab_forwarder_t {

	};

	template<typename stream_type__, typename input_type__>
	struct safe_ostream_with_tab_forwarder_t<stream_type__, input_type__, true> {

		static inline stream_type__& forward(stream_type__& stream, input_type__&& input) {

			stream << input;

			return stream;
		}
	};

	template<typename stream_type__, typename input_type__>
	struct safe_ostream_with_tab_forwarder_t<stream_type__, input_type__, false> {

		static inline stream_type__& forward(stream_type__& stream, input_type__&& input) {

			safe_ostream_t(stream, input.first);

			return stream;
		}
	};
	// \endcond



	/**
	 *	Take the out streaming operation safely with tabs.
	 *	If data is out streamable, stream out the data with tabs.
	 *	Otherwise, do nothing and wont cause any error.
	 */
	template<typename stream_type__, typename type__, typename input_type__ = ostream_input_t<type__>>
	inline stream_type__& safe_ostream_with_tab_t(stream_type__& stream, input_type__&& input) {

		using safe_ostream_with_tab_forward_type = safe_ostream_with_tab_forwarder_t<
			stream_type__,
			input_type__,
			utilities::is_ostreamable_t<
				stream_type__,
				input_type__
			>::value
		>;

		return safe_ostream_with_tab_forward_type::forward(stream, std::forward<input_type__>(input));
	}



	// \cond INTERNAL
	template<typename stream_type__, typename type__, b8 is_streamable__>
	struct safe_istream_forwarder_t {

	};

	template<typename stream_type__, typename type__>
	struct safe_istream_forwarder_t<stream_type__, type__, true> {

		static inline stream_type__& forward(stream_type__& stream, type__&& data) {

			stream >> data;

			return stream;
		}
	};

	template<typename stream_type__, typename type__>
	struct safe_istream_forwarder_t<stream_type__, type__, false> {

		static inline stream_type__& forward(stream_type__& stream, type__&& data) {



			return stream;
		}
	};
	// \endcond



	/**
	 *	Take the in streaming operation safely.
	 *	If data is in streamable, stream in the data.
	 *	Otherwise, do nothing and wont cause any error.
	 */
	template<typename stream_type__, typename type__>
	inline stream_type__& safe_istream_t(stream_type__& stream, type__&& data) {

		using safe_istream_forward_type = safe_istream_forwarder_t<
			stream_type__,
			type__,
			utilities::is_istreamable_t<
				stream_type__,
				type__
			>::value
		>;

		return safe_istream_forward_type::forward(stream, std::forward<type__>(data));
	}

}

